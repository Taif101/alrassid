<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø§Ù„Ø±Ø§ØµØ¯ | AL RASSED</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Outfit:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body>
    <div class="header">
        <div class="app-container">
            <div class="header-content">
                <div class="logo-area">
                    <div class="logo-vibe">ğŸ“¡</div>
                    <div>
                        <h1 style="font-size: 20px; font-weight: 800; letter-spacing: -0.5px;">Ø§Ù„Ø±Ø§ØµØ¯</h1>
                        <p id="priceUpdateTime" style="font-size: 10px; color: var(--accent-green);">Ù…ØªØµÙ„ ÙˆÙ…Ø¨Ø§Ø´Ø±</p>
                    </div>
                </div>
                <div class="status-indicator">
                    <span id="lastUpdate" style="font-size: 12px; opacity: 0.6;">--:--:--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-val" id="totalTrades">0</div>
                <div class="stat-label">Ø§Ù„ØµÙÙ‚Ø§Øª</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" style="color: var(--accent-green)" id="winRate">0%</div>
                <div class="stat-label">Ø§Ù„Ù†Ø¬Ø§Ø­</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="totalProfit">$0</div>
                <div class="stat-label">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>
            </div>
        </div>

        <!-- Live Prices Slider or Grid -->
        <h2 class="section-head">ğŸ“ˆ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­ÙŠØ©</h2>
        <div id="livePrices"
            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 24px;">
            <!-- Live prices here -->
        </div>

        <!-- Live Signals -->
        <h2 class="section-head">ğŸš€ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h2>
        <div id="activeTrades">
            <div style="text-align: center; padding: 40px; opacity: 0.5;">ğŸ“¡ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª...</div>
        </div>
    </div>

    <!-- Modal (Bottom Sheet Style) -->
    <div id="tradeModal" class="modal-overlay">
        <div class="modal-sheet">
            <div class="handle"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="modalSymbol" style="font-size: 28px; font-weight: 800;">SYMBOL</h2>
                <div id="modalType" class="type-badge">BUY</div>
            </div>

            <div class="modal-row"><span class="modal-label">Ø§Ù„Ù‚ÙˆØ©</span><span class="modal-val"
                    id="modalConfluence">--</span></div>
            <div class="modal-row"><span class="modal-label">Ø§Ù„ØªÙˆØ§ÙÙ‚</span><span class="modal-val"
                    id="modalTFs">--</span></div>
            <div class="modal-row"><span class="modal-label">Ø§Ù„Ø­Ø§Ù„Ø©</span><span class="modal-val"
                    id="modalStatus">--</span></div>
            <div class="modal-row"><span class="modal-label">Ø§Ù„Ø³ÙˆÙ‚</span><span class="modal-val"
                    id="modalMarket">--</span></div>
            <div class="modal-row"><span class="modal-label">Ø§Ù„ÙˆÙ‚Øª</span><span class="modal-val"
                    id="modalTime">--</span></div>

            <div class="price-box" style="border-right: 4px solid var(--accent-gold);">
                <span class="modal-label">Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                <span id="modalEntry"
                    style="font-size: 24px; font-weight: 800; color: var(--accent-gold);">0.0000</span>
            </div>

            <div class="price-box" style="border-right: 4px solid var(--accent-red);">
                <span class="modal-label">ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©</span>
                <span id="modalSL" style="font-size: 24px; font-weight: 800; color: var(--accent-red);">0.0000</span>
            </div>

            <div style="margin-top: 20px;">
                <p style="font-size: 14px; font-weight: 700; color: var(--accent-green); margin-bottom: 12px;">ğŸ¯
                    Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</p>
                <div class="levels-grid">
                    <div class="level-item"><span class="level-label">TP1</span><span class="level-val"
                            id="modalTP1">--</span></div>
                    <div class="level-item"><span class="level-label">TP2</span><span class="level-val"
                            id="modalTP2">--</span></div>
                    <div class="level-item"><span class="level-label">TP3</span><span class="level-val"
                            id="modalTP3">--</span></div>
                    <div class="level-item"><span class="level-label">TP4</span><span class="level-val"
                            id="modalTP4">--</span></div>
                </div>
            </div>

            <button onclick="closeModal()"
                style="width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--bg-inner); color: var(--text-main); font-weight: 700; margin-top: 24px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://alrassid-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const tradesRef = database.ref('trades');
        const statsRef = database.ref('stats');
        const liveRef = database.ref('live');
        const lastUpdateRef = database.ref('last_update');

        let livePrices = {};
        let knownSignals = new Set();
        let firstLoad = true;
        let tradeStatusUpdates = {}; // Ù„ØªØªØ¨Ø¹ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©

        function playNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                if (ctx.state === 'suspended') ctx.resume();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.value = 800; gain.gain.value = 0.1;
                osc.start(); osc.stop(ctx.currentTime + 0.1);
            } catch (e) { console.log('Audio error:', e); }
        }

        // ÙˆØ¸ÙŠÙØ© ÙØ­Øµ Ø¥Ø°Ø§ ØªÙ… Ø¶Ø±Ø¨ Ø§Ù„Ù‡Ø¯Ù
        function isHit(type, currentPrice, targetPrice) {
            if (!currentPrice || !targetPrice || targetPrice === '-') return false;
            const cur = parseFloat(currentPrice);
            const tar = parseFloat(targetPrice);
            if (type === 'BUY') return cur >= tar;
            if (type === 'SELL') return cur <= tar;
            return false;
        }

        // Stats Updates
        statsRef.on('value', (s) => {
            const data = s.val() || {};
            document.getElementById('totalTrades').textContent = data.total || 0;
            const winRate = data.total > 0 ? Math.round((data.wins / data.total) * 100) : 0;
            document.getElementById('winRate').textContent = winRate + '%';
            document.getElementById('totalProfit').textContent = '$' + (data.totalProfit || 0).toFixed(2);
        });

        // â•â•â• ØªØªØ¨Ø¹ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„ØµÙÙ‚Ø§Øª (Ø³ØªÙˆØ¨/Ù‡Ø¯Ù/Ø¥ØºÙ„Ø§Ù‚) â•â•â•
        lastUpdateRef.on('value', (s) => {
            const update = s.val();
            if (!update) return;

            // Ù†Ø­ÙØ¸ Ø¢Ø®Ø± Ø­Ø§Ù„Ø© Ù„ÙƒÙ„ Ø²ÙˆØ¬
            tradeStatusUpdates[update.symbol] = {
                status: update.status,
                profit: update.profit,
                timestamp: update.timestamp
            };

            console.log('ğŸ“¡ Status Update:', update.symbol, 'â†’', update.status);
            updateTradeCards(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙˆØ±Ø§Ù‹
        });

        // Live Prices
        liveRef.on('value', (s) => {
            const data = s.val();
            if (!data) return;
            livePrices = data.prices || {};
            const container = document.getElementById('livePrices');
            container.innerHTML = '';
            Object.entries(livePrices).forEach(([sym, price]) => {
                container.innerHTML += `
                    <div class="stat-box" style="padding: 10px;">
                        <div style="font-size: 11px; color: var(--text-muted);">${sym}</div>
                        <div style="font-size: 16px; font-weight: 800; font-family: 'Outfit';">${price}</div>
                    </div>
                `;
            });
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ar-EG');
            updateTradeCards();
        });

        let currentTrades = {};

        // Trade Cards Logic
        tradesRef.orderByChild('timestamp').limitToLast(20).on('value', (snapshot) => {
            currentTrades = snapshot.val() || {};
            updateTradeCards();
        });

        function updateTradeCards() {
            const container = document.getElementById('activeTrades');
            if (!currentTrades) return;
            container.innerHTML = '';

            const entries = Object.entries(currentTrades).reverse();
            const now = Date.now();
            const ONE_HOUR = 60 * 60 * 1000;

            entries.forEach(([key, trade]) => {
                const isNew = !knownSignals.has(key);
                if (isNew) {
                    knownSignals.add(key);
                    if (!firstLoad) playNotificationSound();
                }

                // â•â•â• ÙØ­Øµ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† last_update â•â•â•
                const statusUpdate = tradeStatusUpdates[trade.symbol];
                let finalStatus = trade.status;
                if (statusUpdate && statusUpdate.timestamp > trade.timestamp) {
                    finalStatus = statusUpdate.status;
                }

                // Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø§Ø¹Ø©) ØªØ¹ØªØ¨Ø± Ù…Ù†ØªÙ‡ÙŠØ©
                const tradeAge = now - trade.timestamp;
                if (tradeAge > ONE_HOUR && finalStatus === 'signal') {
                    finalStatus = 'expired';
                }

                const price = livePrices[trade.symbol] || null;
                const tp1Hit = isHit(trade.type, price, trade.tp1);
                const tp2Hit = isHit(trade.type, price, trade.tp2);
                const tp3Hit = isHit(trade.type, price, trade.tp3);
                const tp4Hit = isHit(trade.type, price, trade.tp4);

                const timeDiff = Math.abs(Math.round(tradeAge / 60000));
                let timeText = timeDiff < 1 ? 'Ø§Ù„Ø¢Ù†' : `Ù…Ù†Ø° ${timeDiff} Ø¯`;
                if (timeDiff >= 60) timeText = `Ù…Ù†Ø° ${Math.floor(timeDiff / 60)} Ø³`;

                const isClosed = ['closed', 'tp', 'sl', 'expired'].includes(finalStatus);

                // ØªØ­Ø¯ÙŠØ¯ Ù†Øµ Ø§Ù„Ø­Ø§Ù„Ø©
                let statusText = 'ğŸ“¡ Ø¥Ø´Ø§Ø±Ø©';
                let statusColor = '';
                if (finalStatus === 'tp') { statusText = 'ğŸ¯ Ø¬Ø§Ø¨Øª Ù‡Ø¯Ù'; statusColor = 'color: var(--accent-green);'; }
                else if (finalStatus === 'sl') { statusText = 'ğŸ›‘ Ø³ØªÙˆØ¨'; statusColor = 'color: var(--accent-red);'; }
                else if (finalStatus === 'closed') { statusText = 'ğŸ Ù…ØºÙ„Ù‚Ø©'; statusColor = 'color: var(--text-muted);'; }
                else if (finalStatus === 'expired') { statusText = 'â±ï¸ Ø§Ù†ØªÙ‡Øª'; statusColor = 'color: var(--text-muted);'; }
                else if (finalStatus === 'open') { statusText = 'ğŸŸ¢ Ø¬Ø§Ø±ÙŠØ©'; }

                const card = document.createElement('div');
                card.className = `trade-card ${isNew && !firstLoad ? 'new-signal' : ''} ${isClosed ? 'closed' : ''}`;
                card.onclick = () => openModal(trade, finalStatus);

                card.innerHTML = `
                    <div class="card-top">
                        <div class="symbol-info">
                            <h3>${trade.symbol}</h3>
                            <div class="badge-row">
                                <span class="badge" style="${statusColor}">${statusText}</span>
                                <span class="badge">ğŸ“Š ${trade.confluence}/5</span>
                                <span class="badge">â° ${timeText}</span>
                            </div>
                        </div>
                        <div class="type-badge ${trade.type === 'BUY' ? 'type-buy' : 'type-sell'}" style="${isClosed ? 'opacity:0.5' : ''}">
                            ${trade.type === 'BUY' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'}
                        </div>
                    </div>
                    <div class="levels-grid">
                        <div class="level-item"><span class="level-label">Ø§Ù„Ø¯Ø®ÙˆÙ„</span><span class="level-val val-entry">${trade.entry}</span></div>
                        <div class="level-item"><span class="level-label">Ø§Ù„Ø³ØªÙˆØ¨</span><span class="level-val val-sl">${trade.sl}</span></div>
                        <div class="level-item ${tp1Hit ? 'hit' : ''}"><span class="level-label">TP1 ${tp1Hit ? 'âœ…' : ''}</span><span class="level-val val-tp">${trade.tp1 || '-'}</span></div>
                        <div class="level-item ${tp2Hit ? 'hit' : ''}"><span class="level-label">TP2 ${tp2Hit ? 'âœ…' : ''}</span><span class="level-val val-tp">${trade.tp2 || '-'}</span></div>
                        <div class="level-item ${tp3Hit ? 'hit' : ''}"><span class="level-label">TP3 ${tp3Hit ? 'âœ…' : ''}</span><span class="level-val val-tp">${trade.tp3 || '-'}</span></div>
                        <div class="level-item ${tp4Hit ? 'hit' : ''}"><span class="level-label">TP4 ${tp4Hit ? 'âœ…' : ''}</span><span class="level-val val-tp">${trade.tp4 || '-'}</span></div>
                    </div>
                `;
                container.appendChild(card);
            });
            firstLoad = false;
        }

        function openModal(trade, finalStatus = null) {
            const status = finalStatus || trade.status;

            document.getElementById('modalSymbol').textContent = trade.symbol;
            const typeEl = document.getElementById('modalType');
            typeEl.textContent = trade.type === 'BUY' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹';
            typeEl.className = `type-badge ${trade.type === 'BUY' ? 'type-buy' : 'type-sell'}`;

            document.getElementById('modalConfluence').textContent = (trade.confluence || '?') + '/5';
            document.getElementById('modalTFs').textContent = trade.agreeTFs || 'N/A';

            // ØªØ­Ø¯ÙŠØ¯ Ù†Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ©
            let statusText = 'ğŸ“¡ Ø¥Ø´Ø§Ø±Ø©';
            if (status === 'tp') statusText = 'ğŸ¯ Ø¬Ø§Ø¨Øª Ù‡Ø¯Ù!';
            else if (status === 'sl') statusText = 'ğŸ›‘ Ø¶Ø±Ø¨Øª Ø³ØªÙˆØ¨';
            else if (status === 'open') statusText = 'ğŸŸ¢ Ø¬Ø§Ø±ÙŠØ©';
            else if (status === 'closed') statusText = 'ğŸ Ù…ØºÙ„Ù‚Ø©';
            else if (status === 'expired') statusText = 'â±ï¸ Ø§Ù†ØªÙ‡Øª';

            document.getElementById('modalStatus').textContent = statusText;
            document.getElementById('modalMarket').textContent = trade.marketStatus === 'OPEN' ? 'ğŸŸ¢ Ù…ÙØªÙˆØ­' : 'ğŸ”´ Ù…ØºÙ„Ù‚';

            const timeDiff = Math.abs(Math.round((Date.now() - trade.timestamp) / 60000));
            let timeText = timeDiff < 1 ? 'Ø§Ù„Ø¢Ù†' : 'Ù…Ù†Ø° ' + timeDiff + ' Ø¯Ù‚ÙŠÙ‚Ø©';
            if (timeDiff >= 60) timeText = 'Ù…Ù†Ø° ' + Math.floor(timeDiff / 60) + ' Ø³Ø§Ø¹Ø©';
            document.getElementById('modalTime').textContent = timeText;

            document.getElementById('modalEntry').textContent = trade.entry;
            document.getElementById('modalSL').textContent = trade.sl;
            document.getElementById('modalTP1').textContent = trade.tp1 || '-';
            document.getElementById('modalTP2').textContent = trade.tp2 || '-';
            document.getElementById('modalTP3').textContent = trade.tp3 || '-';
            document.getElementById('modalTP4').textContent = trade.tp4 || '-';

            document.getElementById('tradeModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('tradeModal').classList.remove('active');
        }

        window.onclick = (e) => {
            if (e.target == document.getElementById('tradeModal')) closeModal();
        }
    </script>
</body>

</html>