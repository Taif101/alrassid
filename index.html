<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø§Ù„Ø±Ø§ØµØ¯ | AL RASSED</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Outfit:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body>
    <div class="header">
        <div class="app-container">
            <div class="header-content">
                <div class="logo-area">
                    <div class="logo-vibe">ğŸ“¡</div>
                    <div>
                        <h1 style="font-size: 20px; font-weight: 800; letter-spacing: -0.5px;">Ø§Ù„Ø±Ø§ØµØ¯</h1>
                        <p id="priceUpdateTime" style="font-size: 10px; color: var(--accent-green);">Ù…ØªØµÙ„ ÙˆÙ…Ø¨Ø§Ø´Ø±</p>
                    </div>
                </div>
                <div class="status-indicator">
                    <div class="live-pulse"></div>
                    <span id="lastUpdate" style="font-size: 12px; opacity: 0.6;">--:--:--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Stats Dashboard -->
        <div class="stats-dashboard">
            <div class="stat-box stat-primary">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <div class="stat-val" id="totalTrades">0</div>
                    <div class="stat-label">Ø§Ù„ØµÙÙ‚Ø§Øª</div>
                </div>
            </div>
            <div class="stat-box stat-success">
                <div class="stat-icon">ğŸ¯</div>
                <div class="stat-content">
                    <div class="stat-val" id="winRate">0%</div>
                    <div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                </div>
            </div>
            <div class="stat-box stat-gold">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-content">
                    <div class="stat-val" id="totalProfit">$0</div>
                    <div class="stat-label">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
            <button class="filter-tab" data-filter="active">ğŸŸ¢ Ù†Ø´Ø·Ø©</button>
            <button class="filter-tab" data-filter="tp">ğŸ¯ Ù†Ø§Ø¬Ø­Ø©</button>
            <button class="filter-tab" data-filter="sl">ğŸ›‘ Ø®Ø§Ø³Ø±Ø©</button>
        </div>

        <!-- Live Prices Slider -->
        <div class="section-header">
            <h2 class="section-head">ğŸ“ˆ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­ÙŠØ©</h2>
            <span class="live-indicator">Ù…Ø¨Ø§Ø´Ø±</span>
        </div>
        <div id="livePrices" class="live-prices-grid">
            <!-- Live prices here -->
        </div>

        <!-- Active Trades Section -->
        <div class="section-header">
            <h2 class="section-head">ğŸš€ ØªØªØ¨Ø¹ Ø§Ù„ØµÙÙ‚Ø§Øª</h2>
            <div class="trades-counter">
                <span id="activeCount">0</span> Ù†Ø´Ø·Ø©
            </div>
        </div>

        <div id="activeTrades" class="trades-container">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>ğŸ“¡ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª...</p>
            </div>
        </div>
    </div>

    <!-- Modal (Bottom Sheet Style) -->
    <div id="tradeModal" class="modal-overlay">
        <div class="modal-sheet">
            <div class="handle"></div>
            <div class="modal-header">
                <div class="modal-symbol-area">
                    <h2 id="modalSymbol">SYMBOL</h2>
                    <div id="modalType" class="type-badge">BUY</div>
                </div>
                <div id="modalStatusBadge" class="status-badge-large">ğŸ“¡ Ø¥Ø´Ø§Ø±Ø©</div>
            </div>

            <!-- Trade Info Grid -->
            <div class="modal-info-grid">
                <div class="info-item">
                    <span class="info-icon">ğŸ’ª</span>
                    <span class="info-label">Ø§Ù„Ù‚ÙˆØ©</span>
                    <span class="info-val" id="modalConfluence">--</span>
                </div>
                <div class="info-item">
                    <span class="info-icon">ğŸ“Š</span>
                    <span class="info-label">Ø§Ù„ØªÙˆØ§ÙÙ‚</span>
                    <span class="info-val" id="modalTFs">--</span>
                </div>
                <div class="info-item">
                    <span class="info-icon">ğŸ¦</span>
                    <span class="info-label">Ø§Ù„Ø³ÙˆÙ‚</span>
                    <span class="info-val" id="modalMarket">--</span>
                </div>
                <div class="info-item">
                    <span class="info-icon">â°</span>
                    <span class="info-label">Ø§Ù„ÙˆÙ‚Øª</span>
                    <span class="info-val" id="modalTime">--</span>
                </div>
            </div>

            <!-- Price Levels -->
            <div class="modal-prices">
                <div class="price-level entry-level">
                    <div class="price-label">ğŸ“ Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
                    <div class="price-value" id="modalEntry">0.0000</div>
                </div>
                <div class="price-level sl-level">
                    <div class="price-label">ğŸ›‘ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©</div>
                    <div class="price-value" id="modalSL">0.0000</div>
                </div>
            </div>

            <!-- Targets Grid -->
            <div class="targets-section">
                <div class="targets-header">ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</div>
                <div class="targets-grid">
                    <div class="target-item" id="target1">
                        <span class="target-label">TP1</span>
                        <span class="target-val" id="modalTP1">--</span>
                        <span class="target-status" id="tp1Status"></span>
                    </div>
                    <div class="target-item" id="target2">
                        <span class="target-label">TP2</span>
                        <span class="target-val" id="modalTP2">--</span>
                        <span class="target-status" id="tp2Status"></span>
                    </div>
                    <div class="target-item" id="target3">
                        <span class="target-label">TP3</span>
                        <span class="target-val" id="modalTP3">--</span>
                        <span class="target-status" id="tp3Status"></span>
                    </div>
                    <div class="target-item" id="target4">
                        <span class="target-label">TP4</span>
                        <span class="target-val" id="modalTP4">--</span>
                        <span class="target-status" id="tp4Status"></span>
                    </div>
                </div>
            </div>

            <!-- Current Price -->
            <div class="current-price-section">
                <div class="current-price-label">ğŸ’¹ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                <div class="current-price-val" id="modalCurrentPrice">--</div>
                <div class="price-change" id="modalPriceChange"></div>
            </div>

            <button onclick="closeModal()" class="close-modal-btn">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://alrassid-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const tradesRef = database.ref('trades');
        const statsRef = database.ref('stats');
        const liveRef = database.ref('live');
        const lastUpdateRef = database.ref('last_update');

        let livePrices = {};
        let knownSignals = new Set();
        let firstLoad = true;
        let tradeStatusUpdates = {};
        let currentFilter = 'all';

        // â•â•â• Ø­Ø°Ù Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø© â•â•â•
        const ONE_HOUR = 60 * 60 * 1000;

        function cleanupOldTrades() {
            const now = Date.now();
            tradesRef.once('value', (snapshot) => {
                const trades = snapshot.val();
                if (!trades) return;

                Object.entries(trades).forEach(([key, trade]) => {
                    const tradeAge = now - trade.timestamp;
                    const status = trade.status;

                    // Ø­Ø°Ù Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© (tp, sl, closed, expired) Ø§Ù„ØªÙŠ Ù…Ø± Ø¹Ù„ÙŠÙ‡Ø§ Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø§Ø¹Ø©
                    if (['tp', 'sl', 'closed', 'expired'].includes(status) && tradeAge > ONE_HOUR) {
                        tradesRef.child(key).remove()
                            .then(() => console.log('ğŸ—‘ï¸ Cleaned up old trade:', trade.symbol))
                            .catch(err => console.error('Error removing trade:', err));
                    }
                    // Ø£ÙŠØ¶Ø§Ù‹ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø§Ø¹ØªÙŠÙ†) Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªÙ†ØªÙ‡ÙŠ
                    if (tradeAge > ONE_HOUR * 2) {
                        tradesRef.child(key).remove()
                            .then(() => console.log('ğŸ—‘ï¸ Cleaned up stale signal:', trade.symbol))
                            .catch(err => console.error('Error removing trade:', err));
                    }
                });
            });
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
        setInterval(cleanupOldTrades, 5 * 60 * 1000);
        // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        setTimeout(cleanupOldTrades, 5000);

        function playNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                if (ctx.state === 'suspended') ctx.resume();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.value = 880;
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            } catch (e) { console.log('Audio error:', e); }
        }

        // ÙˆØ¸ÙŠÙØ© ÙØ­Øµ Ø¥Ø°Ø§ ØªÙ… Ø¶Ø±Ø¨ Ø§Ù„Ù‡Ø¯Ù
        function isHit(type, currentPrice, targetPrice) {
            if (!currentPrice || !targetPrice || targetPrice === '-' || targetPrice === '') return false;
            const cur = parseFloat(currentPrice);
            const tar = parseFloat(targetPrice);
            if (isNaN(cur) || isNaN(tar)) return false;
            if (type === 'BUY') return cur >= tar;
            if (type === 'SELL') return cur <= tar;
            return false;
        }

        // ÙØ­Øµ Ø¥Ø°Ø§ Ø¶Ø±Ø¨ Ø³ØªÙˆØ¨
        function isSLHit(type, currentPrice, slPrice) {
            if (!currentPrice || !slPrice) return false;
            const cur = parseFloat(currentPrice);
            const sl = parseFloat(slPrice);
            if (isNaN(cur) || isNaN(sl)) return false;
            if (type === 'BUY') return cur <= sl;
            if (type === 'SELL') return cur >= sl;
            return false;
        }

        // Filter Tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                updateTradeCards();
            });
        });

        // Stats Updates
        statsRef.on('value', (s) => {
            const data = s.val() || {};
            animateNumber('totalTrades', data.total || 0);
            const winRate = data.total > 0 ? Math.round((data.wins / data.total) * 100) : 0;
            document.getElementById('winRate').textContent = winRate + '%';
            document.getElementById('totalProfit').textContent = '$' + (data.totalProfit || 0).toFixed(2);
        });

        function animateNumber(elementId, finalValue) {
            const el = document.getElementById(elementId);
            const currentValue = parseInt(el.textContent) || 0;
            if (currentValue === finalValue) return;

            const duration = 500;
            const steps = 20;
            const increment = (finalValue - currentValue) / steps;
            let step = 0;

            const interval = setInterval(() => {
                step++;
                el.textContent = Math.round(currentValue + (increment * step));
                if (step >= steps) {
                    el.textContent = finalValue;
                    clearInterval(interval);
                }
            }, duration / steps);
        }

        // â•â•â• ØªØªØ¨Ø¹ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„ØµÙÙ‚Ø§Øª (Ø³ØªÙˆØ¨/Ù‡Ø¯Ù/Ø¥ØºÙ„Ø§Ù‚) â•â•â•
        lastUpdateRef.on('value', (s) => {
            const update = s.val();
            if (!update) return;

            tradeStatusUpdates[update.symbol] = {
                status: update.status,
                profit: update.profit,
                timestamp: update.timestamp
            };

            console.log('ğŸ“¡ Status Update:', update.symbol, 'â†’', update.status);
            updateTradeCards();
        });

        // Live Prices
        liveRef.on('value', (s) => {
            const data = s.val();
            if (!data) return;
            livePrices = data.prices || {};
            const container = document.getElementById('livePrices');
            container.innerHTML = '';

            Object.entries(livePrices).forEach(([sym, price]) => {
                const priceBox = document.createElement('div');
                priceBox.className = 'price-box';
                priceBox.innerHTML = `
                    <div class="price-symbol">${sym}</div>
                    <div class="price-value">${price}</div>
                `;
                container.appendChild(priceBox);
            });

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ar-EG');
            updateTradeCards();
        });

        let currentTrades = {};

        // Trade Cards Logic - ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        tradesRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
            currentTrades = snapshot.val() || {};
            updateTradeCards();
        });

        function updateTradeCards() {
            const container = document.getElementById('activeTrades');
            if (!currentTrades || Object.keys(currentTrades).length === 0) {
                container.innerHTML = `
                    <div class="loading-state">
                        <div class="empty-icon">ğŸ“¡</div>
                        <p>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª...</p>
                    </div>
                `;
                document.getElementById('activeCount').textContent = '0';
                return;
            }

            container.innerHTML = '';
            const now = Date.now();

            // â•â•â• ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ â•â•â•
            const entries = Object.entries(currentTrades)
                .sort((a, b) => b[1].timestamp - a[1].timestamp);

            let activeCount = 0;
            let displayedCount = 0;

            entries.forEach(([key, trade]) => {
                const isNew = !knownSignals.has(key);
                if (isNew) {
                    knownSignals.add(key);
                    if (!firstLoad) {
                        playNotificationSound();
                        // Vibration API for mobile
                        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    }
                }

                // â•â•â• ÙØ­Øµ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† last_update â•â•â•
                const statusUpdate = tradeStatusUpdates[trade.symbol];
                let finalStatus = trade.status;
                if (statusUpdate && statusUpdate.timestamp > trade.timestamp) {
                    finalStatus = statusUpdate.status;
                }

                // ÙØ­Øµ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆØ§Ù„Ø³ØªÙˆØ¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                const price = livePrices[trade.symbol] || null;
                const tp1Hit = isHit(trade.type, price, trade.tp1);
                const tp2Hit = isHit(trade.type, price, trade.tp2);
                const tp3Hit = isHit(trade.type, price, trade.tp3);
                const tp4Hit = isHit(trade.type, price, trade.tp4);
                const slHit = isSLHit(trade.type, price, trade.sl);

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (finalStatus === 'signal' || finalStatus === 'open') {
                    if (slHit) finalStatus = 'sl';
                    else if (tp1Hit) finalStatus = 'tp';
                }

                const tradeAge = now - trade.timestamp;

                // â•â•â• Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (> 1 Ø³Ø§Ø¹Ø©) â•â•â•
                const isClosed = ['closed', 'tp', 'sl', 'expired'].includes(finalStatus);
                if (isClosed && tradeAge > ONE_HOUR) {
                    return; // skip this trade
                }

                // Filter logic
                if (currentFilter === 'active' && isClosed) return;
                if (currentFilter === 'tp' && finalStatus !== 'tp') return;
                if (currentFilter === 'sl' && finalStatus !== 'sl') return;

                if (!isClosed) activeCount++;
                displayedCount++;

                const timeDiff = Math.abs(Math.round(tradeAge / 60000));
                let timeText = timeDiff < 1 ? 'Ø§Ù„Ø¢Ù†' : `Ù…Ù†Ø° ${timeDiff} Ø¯`;
                if (timeDiff >= 60) timeText = `Ù…Ù†Ø° ${Math.floor(timeDiff / 60)} Ø³`;

                // ØªØ­Ø¯ÙŠØ¯ Ù†Øµ ÙˆØ³ØªØ§ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©
                let statusConfig = getStatusConfig(finalStatus);

                // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºÙŠØ± ÙÙŠ Ø§Ù„Ø³Ø¹Ø±
                let priceChange = '';
                let priceChangeClass = '';
                if (price && trade.entry) {
                    const entryPrice = parseFloat(trade.entry);
                    const currentPrice = parseFloat(price);
                    const diff = currentPrice - entryPrice;
                    const pips = Math.abs(diff * 10000).toFixed(1);
                    if (trade.type === 'BUY') {
                        priceChange = diff >= 0 ? `+${pips} Ù†Ù‚Ø·Ø©` : `-${pips} Ù†Ù‚Ø·Ø©`;
                        priceChangeClass = diff >= 0 ? 'positive' : 'negative';
                    } else {
                        priceChange = diff <= 0 ? `+${Math.abs(pips)} Ù†Ù‚Ø·Ø©` : `-${Math.abs(pips)} Ù†Ù‚Ø·Ø©`;
                        priceChangeClass = diff <= 0 ? 'positive' : 'negative';
                    }
                }

                const card = document.createElement('div');
                card.className = `trade-card ${isNew && !firstLoad ? 'new-signal' : ''} ${isClosed ? 'closed' : ''} status-${finalStatus}`;
                card.onclick = () => openModal(trade, finalStatus, price);

                card.innerHTML = `
                    <div class="card-header">
                        <div class="symbol-section">
                            <h3 class="symbol-name">${trade.symbol}</h3>
                            <div class="symbol-meta">
                                <span class="meta-badge status-badge ${statusConfig.class}">${statusConfig.icon} ${statusConfig.text}</span>
                                <span class="meta-badge time-badge">â° ${timeText}</span>
                            </div>
                        </div>
                        <div class="trade-type ${trade.type === 'BUY' ? 'type-buy' : 'type-sell'}">
                            ${trade.type === 'BUY' ? 'ğŸ“ˆ Ø´Ø±Ø§Ø¡' : 'ğŸ“‰ Ø¨ÙŠØ¹'}
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="price-info-row">
                            <div class="price-info">
                                <span class="label">Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                                <span class="value entry">${trade.entry}</span>
                            </div>
                            <div class="price-info">
                                <span class="label">Ø§Ù„Ø³ØªÙˆØ¨</span>
                                <span class="value sl ${slHit ? 'hit' : ''}">${trade.sl}</span>
                            </div>
                            ${price ? `
                            <div class="price-info current">
                                <span class="label">Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                                <span class="value">${price}</span>
                                <span class="change ${priceChangeClass}">${priceChange}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="targets-row">
                            <div class="target ${tp1Hit ? 'hit' : ''}">
                                <span class="tp-label">TP1</span>
                                <span class="tp-value">${trade.tp1 || '-'}</span>
                                ${tp1Hit ? '<span class="hit-badge">âœ“</span>' : ''}
                            </div>
                            <div class="target ${tp2Hit ? 'hit' : ''}">
                                <span class="tp-label">TP2</span>
                                <span class="tp-value">${trade.tp2 || '-'}</span>
                                ${tp2Hit ? '<span class="hit-badge">âœ“</span>' : ''}
                            </div>
                            <div class="target ${tp3Hit ? 'hit' : ''}">
                                <span class="tp-label">TP3</span>
                                <span class="tp-value">${trade.tp3 || '-'}</span>
                                ${tp3Hit ? '<span class="hit-badge">âœ“</span>' : ''}
                            </div>
                            <div class="target ${tp4Hit ? 'hit' : ''}">
                                <span class="tp-label">TP4</span>
                                <span class="tp-value">${trade.tp4 || '-'}</span>
                                ${tp4Hit ? '<span class="hit-badge">âœ“</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="card-footer">
                            <div class="confluence-meter">
                                <span class="confluence-label">Ù‚ÙˆØ© Ø§Ù„ØªÙˆØ§ÙÙ‚</span>
                                <div class="confluence-bar">
                                    ${generateConfluenceBar(trade.confluence || 0)}
                                </div>
                                <span class="confluence-val">${trade.confluence || 0}/5</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('activeCount').textContent = activeCount;
            firstLoad = false;
        }

        function getStatusConfig(status) {
            const configs = {
                'signal': { icon: 'ğŸ“¡', text: 'Ø¥Ø´Ø§Ø±Ø©', class: 'signal' },
                'open': { icon: 'ğŸŸ¢', text: 'Ø¬Ø§Ø±ÙŠØ©', class: 'open' },
                'tp': { icon: 'ğŸ¯', text: 'Ø¬Ø§Ø¨Øª Ù‡Ø¯Ù', class: 'tp' },
                'sl': { icon: 'ğŸ›‘', text: 'Ø³ØªÙˆØ¨', class: 'sl' },
                'closed': { icon: 'ğŸ', text: 'Ù…ØºÙ„Ù‚Ø©', class: 'closed' },
                'expired': { icon: 'â±ï¸', text: 'Ø§Ù†ØªÙ‡Øª', class: 'expired' }
            };
            return configs[status] || configs['signal'];
        }

        function generateConfluenceBar(confluence) {
            let bars = '';
            for (let i = 1; i <= 5; i++) {
                const active = i <= confluence ? 'active' : '';
                bars += `<div class="bar ${active}"></div>`;
            }
            return bars;
        }

        function openModal(trade, finalStatus = null, currentPrice = null) {
            const status = finalStatus || trade.status;
            const price = currentPrice || livePrices[trade.symbol];

            document.getElementById('modalSymbol').textContent = trade.symbol;
            const typeEl = document.getElementById('modalType');
            typeEl.textContent = trade.type === 'BUY' ? 'ğŸ“ˆ Ø´Ø±Ø§Ø¡' : 'ğŸ“‰ Ø¨ÙŠØ¹';
            typeEl.className = `type-badge ${trade.type === 'BUY' ? 'type-buy' : 'type-sell'}`;

            // Status badge
            const statusConfig = getStatusConfig(status);
            document.getElementById('modalStatusBadge').textContent = statusConfig.icon + ' ' + statusConfig.text;
            document.getElementById('modalStatusBadge').className = `status-badge-large ${statusConfig.class}`;

            document.getElementById('modalConfluence').textContent = (trade.confluence || '?') + '/5';
            document.getElementById('modalTFs').textContent = trade.agreeTFs || 'N/A';
            document.getElementById('modalMarket').textContent = trade.marketStatus === 'OPEN' ? 'ğŸŸ¢ Ù…ÙØªÙˆØ­' : 'ğŸ”´ Ù…ØºÙ„Ù‚';

            const timeDiff = Math.abs(Math.round((Date.now() - trade.timestamp) / 60000));
            let timeText = timeDiff < 1 ? 'Ø§Ù„Ø¢Ù†' : 'Ù…Ù†Ø° ' + timeDiff + ' Ø¯Ù‚ÙŠÙ‚Ø©';
            if (timeDiff >= 60) timeText = 'Ù…Ù†Ø° ' + Math.floor(timeDiff / 60) + ' Ø³Ø§Ø¹Ø©';
            document.getElementById('modalTime').textContent = timeText;

            document.getElementById('modalEntry').textContent = trade.entry;
            document.getElementById('modalSL').textContent = trade.sl;

            // TPs with hit status
            const tp1Val = trade.tp1 || '-';
            const tp2Val = trade.tp2 || '-';
            const tp3Val = trade.tp3 || '-';
            const tp4Val = trade.tp4 || '-';

            document.getElementById('modalTP1').textContent = tp1Val;
            document.getElementById('modalTP2').textContent = tp2Val;
            document.getElementById('modalTP3').textContent = tp3Val;
            document.getElementById('modalTP4').textContent = tp4Val;

            // Check hits
            const tp1Hit = isHit(trade.type, price, tp1Val);
            const tp2Hit = isHit(trade.type, price, tp2Val);
            const tp3Hit = isHit(trade.type, price, tp3Val);
            const tp4Hit = isHit(trade.type, price, tp4Val);

            document.getElementById('tp1Status').textContent = tp1Hit ? 'âœ…' : '';
            document.getElementById('tp2Status').textContent = tp2Hit ? 'âœ…' : '';
            document.getElementById('tp3Status').textContent = tp3Hit ? 'âœ…' : '';
            document.getElementById('tp4Status').textContent = tp4Hit ? 'âœ…' : '';

            document.getElementById('target1').className = `target-item ${tp1Hit ? 'hit' : ''}`;
            document.getElementById('target2').className = `target-item ${tp2Hit ? 'hit' : ''}`;
            document.getElementById('target3').className = `target-item ${tp3Hit ? 'hit' : ''}`;
            document.getElementById('target4').className = `target-item ${tp4Hit ? 'hit' : ''}`;

            // Current price and change
            document.getElementById('modalCurrentPrice').textContent = price || '--';
            if (price && trade.entry) {
                const entryPrice = parseFloat(trade.entry);
                const cur = parseFloat(price);
                const diff = cur - entryPrice;
                const pips = Math.abs(diff * 10000).toFixed(1);
                let changeText = '';
                let changeClass = '';
                if (trade.type === 'BUY') {
                    changeText = diff >= 0 ? `+${pips} Ù†Ù‚Ø·Ø©` : `-${pips} Ù†Ù‚Ø·Ø©`;
                    changeClass = diff >= 0 ? 'positive' : 'negative';
                } else {
                    changeText = diff <= 0 ? `+${Math.abs(pips)} Ù†Ù‚Ø·Ø©` : `-${Math.abs(pips)} Ù†Ù‚Ø·Ø©`;
                    changeClass = diff <= 0 ? 'positive' : 'negative';
                }
                document.getElementById('modalPriceChange').textContent = changeText;
                document.getElementById('modalPriceChange').className = `price-change ${changeClass}`;
            }

            document.getElementById('tradeModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('tradeModal').classList.remove('active');
        }

        // Close modal on overlay click
        document.getElementById('tradeModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeModal();
        });

        // Keyboard escape to close
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>

</html>